# Отчёт о проделанной работе (17 дней)

Ниже — детализированный отчёт по развитию корпоративного Telegram‑бота и сервисов LLM за 17 рабочих дней. Отчёт включает цель, сделанные изменения, принятые архитектурные решения, безопасность, эксплуатацию и планы.

## Краткое резюме
За 17 дней мы превратили исходный прототип в полноценное решение с регистрацией сотрудников, интеграцией с СУБД, улучшенным UX, гибридным RAG‑поиском (FAISS+BM25), индексацией документов, учётом токенов модели и понятной документацией/деплоем.

Ключевые результаты:
- Регистрация: проверка ФИО+табельный по БД (SQLite/MySQL/MSSQL) и из файлов выгрузки (CSV/JSON/TXT).
- UX: кнопка «повтор», /cancel, /status, доступ к /ask и /help только после регистрации, приветствие.
- RAG: локальная индексация .docx в боте + гибридный поиск в сервисе модели (FAISS+BM25, реранкинг косинусом) с отображением источников и порогом уверенности.
- LLM сервис: llama‑cpp (GGUF), эндпоинты /generate, /embed, /index, /search, /usage; учёт месячных выходных токенов.
- Безопасность: вынесение секретов в .env, логирование в logs/, рекомендации по ACL/БД.
- Документация: обновлённый README с командами запуска, индексацией и конфигами.

---

## День за днём

### День 1. Аудит кода и первичный план
- Просмотр исходников: `bot.py`, `main.py`, `database.py`, `model_service.py`, `llm_client.py`, скрипты деплоя.
- Выявлено:
  - Секреты (API‑token) в коде, логирование в корень, смешение форматов моделей (GGUF vs transformers).
  - RAG на numpy без полноценного хранилища, простая индексация .docx, нет нормализации ввода.
- Сформирован план миграции: вынести секреты в `.env`, привести модель к llama‑cpp, улучшить RAG, разделить ответственности.

### День 2. Конфиг и секреты
- Перенёс секреты в `.env`, добавил `config.py` с загрузкой переменных окружения.
- Логи переведены в `logs/`, настроен формат логов.
- README обновлён: быстрый старт, команды, .env.

### День 3. LLM‑сервис (GGUF, llama‑cpp)
- `model_service.py`: переход на `llama-cpp-python` (GGUF), отказ от `transformers` для основной модели.
- Эндпоинты `/health`, `/generate`, `/embed`, базовая телеметрия.
- Обновлены зависимости `requirements.txt` (убраны transformers/torch, добавлен llama‑cpp).

### День 4. Бот → сервис
- `bot.py`: перевёл генерацию и эмбеддинги через HTTP‑клиент к сервису модели.
- Структурировал обработчики `/start`, `/ask`, `/train`.
- Индексация .docx: извлечение текста, чанкинг, эмбеддинги через сервис.

### День 5. Регистрация и верификация
- Улучшил регистрацию: состояния, лимиты попыток, уведомления админу.
- Верификация ФИО+табельный через локальную БД (`aiosqlite`).
- Добавлены логи попыток в БД.

### День 6. Поддержка БД (MySQL)
- `database.py`: условная поддержка MySQL (через `aiomysql`) для чтения сотрудников (read‑only таблица/вью employees).
- Настройки MySQL в `.env`.

### День 7. Поддержка БД (MS SQL)
- Добавлена поддержка MS SQL Server через `aioodbc`/`pyodbc` и ODBC Driver 18.
- Приоритет чтения: MSSQL → MySQL → SQLite, чтобы гибко подключаться к корпоративным источникам.

### День 8. Вариант A (без прямого доступа к 1С)
- `onec_sync.py`: импорт сотрудников из выгрузок 1С (CSV/JSON), маппинг колонок (`employee_id`, `full_name`, ...).
- `README`: переменная `ONEC_EXPORT_PATH`, использование файла выгрузки.

### День 9. Парсер TXT выгрузок 1С
- Расширил `onec_sync.py`: поддержка `.txt` с «рваными» отступами.
- Нормализация пробелов, неразрывных пробелов, разбор по последнему токену.
- Отладка на реальном файле — распарсили 2 819 записей.

### День 10. Кэш сотрудников и отказ от Redis
- Временно подключали Redis для лимитов/кэша, затем исключили (из‑за окружения).
- Сделали полностью файловую/БД‑схему: кэш сотрудников в памяти процесса; синхронизация раз в час из файла/БД.

### День 11. Нормализация ввода
- Добавлена нормализация ФИО и табельных: схлопывание пробелов, унификация дефисов (`–` → `-`), верхний регистр ID.
- Сопоставление по нормализованным значениям и индексу `EMPLOYEES_BY_NORM_ID`.

### День 12. Улучшения UX регистрации
- Кнопка «повтор» после неуспеха, /cancel для сброса шага, /status (профиль).
- `AUTHORIZED_USERS`/`AUTHORIZED_INFO` — хранение состояния авторизации.
- Доступ к `/ask` и `/help` только после регистрации.

### День 13. Приветствие
- После успешной регистрации: развернутое приветствие (что умеет бот, как задавать вопросы, полезные команды).

### День 14. Гибридный RAG
- В `model_service.py` добавлены:
  - `/index` — индексация массива текстов, хранение корпуса и эмбеддингов в памяти процесса.
  - `/search` — гибридный поиск BM25 + FAISS и реранкинг косинусом (Sentence‑Transformers).
- В боте:
  - `/train` помимо локальной индексации отправляет текст в `/index` сервиса.
  - `/ask` использует `/search`; добавлен порог уверенности и «Источники» (score).

### День 15. Документация и команды
- README дополнен: описание гибридного поиска, индексация через API, новые команды (`/status`, `/cancel`), источники в ответах.

### День 16. Учёт выходных токенов
- В сервисе модели:
  - Учёт месячных выходных токенов, авто‑сброс по месяцу.
  - `MONTHLY_TOKEN_LIMIT` (дефолт 10 млн) и `TOKEN_ALERT_THRESHOLD` (дефолт 80%).
  - `/usage` и блок `usage` в `/health`; расширенный ответ `/generate` с метриками.

### День 17. Репозиторий и деплой
- Коммиты и push на GitHub: код бота, LLM‑сервиса, парсеров и README.
- Чистка `.env`, проверка скриптов `setup.sh`, `dev.sh`.

---

## Текущее состояние архитектуры
- Telegram Bot (`bot.py`):
  - Регистрация сотрудников (ФИО+табельный), нормализация, хранение статуса.
  - UX: /start, /status, /cancel, «повтор», доступ /ask|/help после авторизации.
  - Индексация .docx и отправка текста в сервис `/index`.
  - Вопросы: `/search` → контекст → `/generate`, с источниками и порогом уверенности.
- Model Service (`model_service.py`):
  - GGUF (llama‑cpp), Sentence‑Transformers.
  - `/generate`, `/embed`, `/index`, `/search`, `/usage`, `/health`.
  - Гибридный RAG (FAISS+BM25), учёт токенов в месяц.
- БД:
  - SQLite по умолчанию; поддержка MySQL/MSSQL для источника сотрудников.
  - Импорт выгрузок 1С (CSV/JSON/TXT), периодическая синхронизация в память.

## Безопасность
- Секреты в `.env`, логи в `logs/`.
- Рекомендации: read‑only пользователи БД, ACL документов, фильтрация ПДн, шифрование диска/бэкапов.
- Для MSSQL: ODBC Driver 18, DSN/строка подключения, права только SELECT на `employees`.

## Эксплуатация
- Индексация документов: `/train` или `/index` (API).
- Мониторинг usage: `/usage` и `usage` в `/health` (месячные токены).
- Настройка порога уверенности в боте; источники в ответах.
- Dev/Prod: systemd для сервисов, скрипты `setup.sh`, `dev.sh`.

## Что ещё можно улучшить
- Метаданные источников (название файла, ссылка/раздел), цитаты с подсветкой.
- Постоянное хранилище для эмбеддингов (FAISS на диске / pgvector / OpenSearch) и инкрементальный апдейт.
- Реранкер на более сильной модели (Cross‑Encoder), A/B‑тесты.
- ACL в RAG по пользователям/ролям.
- Дашборд (Grafana/Prometheus) по латентности, hit‑rate, usage.

## Заключение
За 17 дней бот получил продвинутые функции корпоративного ассистента с акцентом на надёжную регистрацию, хороший поиск по документам и управляемый расход токенов. Код и документация готовы к развёртыванию на сервере и к дальнейшему развитию под рост нагрузки и источников. 