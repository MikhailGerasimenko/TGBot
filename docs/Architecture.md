# Архитектура проекта

## Обзор
Проект состоит из двух сервисов:
- Telegram Bot (aiogram): регистрация/верификация пользователей, UX, аналитика, обращения к Model Service.
- Model Service (FastAPI): LLM‑генерация (llama‑cpp), эмбеддинги (sentence‑transformers), гибридный поиск (FAISS+BM25) и Cross‑Encoder реранкинг.

## Компоненты
- `bot.py`: хендлеры команд, логика регистрации, вопросы/ответы, загрузка документов.
- `main.py`: единая точка входа бота, инициализация БД, диспетчер, периодическая синхронизация.
- `model_service.py`: эндпоинты `/health`, `/generate`, `/embed`, `/index`, `/search`, `/search_v2`, `/usage`.
- `database.py`: MSSQL/MySQL/SQLite, аналитика, фидбек, логирование неотвеченных вопросов.
- `onec_sync.py`: загрузка сотрудников из выгрузок 1С (csv/json/txt), нормализация.
- `llm_client.py`: клиент к Model Service (таймауты, JSON).
- `progress_bars.py`: прогресс‑индикаторы в ответах Telegram.
- `config.py`: конфигурация из `.env`, создание директорий.

## Потоки данных
1. Пользователь → Bot: вопрос (/ask).
2. Bot → Model Service: `/search` или `/search_v2` для контекста.
3. Bot → Model Service: `/generate` с контекстом.
4. Bot → Пользователь: ответ + источники + кнопки фидбека.
5. Bot → SQLite: лог сессии Q&A, фидбек, неотвеченные вопросы.

## RAG
- Индексация: `/index` принимает массив чанков текста; сервис сохраняет FAISS, BM25 токены и корпуса, плюс сериализует индекс на диск.
- Поиск v1: объединение кандидатов FAISS/BM25 → косинусный реранкинг.
- Поиск v2: объединённые кандидаты → Cross‑Encoder реранкинг (точнее, дороже).
- Query Expansion (в боте): для длинных запросов генерируются перефразировки: повышает полноту.

## A/B тестирование
- Конфиг: `USE_SEARCH_V2` (включить всем) и `SEARCH_V2_PERCENTAGE` (доля пользователей на v2).
- Отчёт: `/compare_search` — сравнение v1/v2 по времени, уверенности и фидбеку.

## Регистрация и верификация
- Путь: MSSQL → MySQL → SQLite (fallback), либо по выгрузке 1С из файла.
- Анти‑брутфорс: ограничение попыток/сутки, «повтор», уведомления администратору.

## Директории и персистентность
- `models/`: GGUF, сериализованный индекс поиска.
- `docs/`: источники .docx, индексируемые через `/train`.
- `logs/`: логи бота и сервиса модели.

## Наблюдаемость/надёжность
- `healthcheck` для Model Service.
- Персистентный индекс на диск (быстрый рестарт без переиндексации).
- Порог уверенности: отсутствие «галлюцинаций» при низком score. 