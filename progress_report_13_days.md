# Отчёт о проделанной работе (13 дней, проект с нуля)

Ниже приведён максимально подробный дневной отчёт о создании корпоративного Telegram‑бота и сервисов LLM с нуля до текущего состояния за 13 дней. Фиксируются цели, сделанные изменения, ключевые файлы, архитектурные решения, риски и результаты.

## Итог за 13 дней (кратко)
- Реализован гибридный RAG‑поиск (FAISS + BM25 + реранкинг косинусом) и локальная индексация .docx.
- Поднят сервис LLM (llama‑cpp, GGUF), с эндпоинтами `/generate`, `/embed`, `/index`, `/search`, `/usage`, `/health`.
- Проведена нормализация ФИО/ID и улучшения UX (/status, /cancel, «повтор», приветствие, источники в ответе).
- Добавлен счётчик выходных токенов (месячный учёт, пороговые алерты) и обновлена документация.

---

## День 1 — Инициализация репозитория и окружения
**Цель:** заложить базу проекта, стандартизировать конфигурацию и логи.
- Создан репозиторий и базовая структура каталогов: `docs/`, `logs/`, `models/`, `backups/`.
- Добавлен `config.py` с загрузкой `.env` и созданием необходимых директорий.
- Секреты вынесены в `.env` (Telegram API token, ADMIN_CHAT_ID, БД и т.д.).
- Базовый `README.md` с установкой/запуском.
- Логи перенесены в `logs/` (формат унифицирован).

Ключевые файлы: `config.py`, `.env`, `README.md`, `setup.sh`, `dev.sh`.

Результат: проект стартует, есть конфиг, структура и скрипты для DEV.

---

## День 2 — Telegram‑бот: скелет и регистрация (in‑memory)
**Цель:** поднять рабочий бот с обработчиками команд и регистрацией в памяти.
- Создан `bot.py`: /start, /help, /ask (заглушка), обработка состояний пользователя.
- Реализована первичная регистрация: ввод ФИО → ввод табельного (валидация формата, без БД).
- Добавлены клавиатуры (основная) и логирование действий в файл.

Ключевые файлы: `bot.py`, `main.py` (старт polling), `requirements.txt` (aiogram и пр.).

Результат: бот отвечает и проводит пользователя через простую регистрацию.

---

## День 3 — База данных: SQLite для сотрудников и логов
**Цель:** привязать регистрацию к БД для верификации.
- Создан `database.py`: 
  - `init_db`, `populate_test_data`, `verify_employee`, `get_all_employees`, `log_registration_attempt`.
  - Таблицы: `employees`, `registration_attempts`.
- Обновлён `bot.py`: регистрация сверяет ФИО+табельный с таблицей `employees`.
- Логи попыток пишутся в `registration_attempts`.

Ключевые файлы: `database.py`, `init_db.py`.

Результат: регистрация валидируется по БД; есть журнал попыток.

---

## День 4 — LLM‑сервис (GGUF, llama‑cpp) и клиент
**Цель:** вынести генерацию ответов в отдельный сервис на FastAPI.
- `model_service.py` (FastAPI): `/health`, `/generate`, `/embed`.
- Выбор стека: GGUF + `llama-cpp-python` (совместимо с локальными ресурсами, не зависит от HF transformers).
- `llm_client.py`: клиент для бота (health/generate/embed).
- В `bot.py` — генерация ответов через сервис, при отсутствии контекста.

Результат: сервисная архитектура, бот обращается к API модели.

---

## День 5 — Верификация из внешних СУБД (MySQL, MS SQL)
**Цель:** позволить использовать корпоративные источники сотрудников.
- `database.py`:
  - Поддержка MySQL (`aiomysql`) и MSSQL (`aioodbc`/`pyodbc`).
  - Приоритет чтения: MSSQL → MySQL → SQLite.
- `.env`: блоки настроек для MySQL/MSSQL.
- Рекомендации по созданию read‑only пользователя и вью `employees`.

Результат: гибкость подключения к корпоративной БД без изменения логики бота.

---

## День 6 — Вариант A: импорт из 1С без прямого доступа
**Цель:** уметь работать с выгрузками 1С (CSV/JSON), без SQL‑интеграции.
- `onec_sync.py`: загрузка сотрудников из CSV/JSON, маппинг колонок, фильтрация.
- Поддержка переменной `ONEC_EXPORT_PATH` в `.env` и периодическая синхронизация в память.
- В `bot.py`: приоритет загрузки из файла, fallback к БД.

Результат: автономная работа от файловой выгрузки.

---

## День 7 — Парсер TXT‑выгрузок 1С
**Цель:** поддержать «неровные» TXT‑файлы (ФИО … табельный).
- `onec_sync.py`: 
  - Нормализация Unicode‑пробелов, разбор по «последнему токену» как табельному.
  - Игнор заголовков, пустых строк.
- Тест на реальном файле: распарсили 2 819 сотрудников.

Результат: проект устойчив к разнообразию форматов выгрузок.

---

## День 8 — Нормализация ввода и точное сопоставление
**Цель:** снизить ошибки регистрации «из‑за дефисов/пробелов».
- В `bot.py`:
  - Нормализация ФИО: схлопывание пробелов, нижний регистр.
  - Нормализация табельного: все дефисы → `-`, удаление пробелов внутри, верхний регистр.
  - Индекс `EMPLOYEES_BY_NORM_ID` в памяти, сопоставление по нормализованным значениям.

Результат: корректная регистрация при «00ЗП‑00041» vs `00ЗП-00041` и вариациях.

---

## День 9 — Улучшения UX
**Цель:** сделать сценарий пользователя дружелюбным.
- Кнопка «повтор» после неудачи; команда `/cancel`.
- `/status` — профиль пользователя (ФИО, табельный, время регистрации).
- Блокировка `/ask` и `/help` до завершения регистрации.
- Приветственное сообщение после успешной регистрации (инструкция/команды).

Результат: сценарии стали понятнее, меньше вопросов «что дальше». 

---

## День 10 — Гибридный RAG‑поиск
**Цель:** улучшить релевантность и скорость поиска по документам.
- В `model_service.py` добавлено:
  - `/index` — индексация массива текстов (корпус + эмбеддинги в памяти).
  - `/search` — BM25 + FAISS (IP, косинусные нормы) и реранкинг косинусом.
- В боте `/ask` сначала вызывает `/search` (top‑k контекст), затем `/generate`.
- Порог уверенности: при низком score — просьба уточнить вопрос.
- Ответ включает «Источники» (score) для прозрачности.

Результат: заметно выше точность ответов и контролируемые галлюцинации.

---

## День 11 — Индексация документов и RAG локально
**Цель:** удобный ввод знаний через /train.
- В `bot.py` команда `/train` (для админа): загрузка .docx, 
  - локальная индексация (чанкинг),
  - отправка полного текста в `/index` сервиса для гибридного поиска.
- `extract_text_from_docx` и `split_text_into_chunks` доведены для устойчивости.

Результат: новые документы сразу доступны для поиска и ответов.

---

## День 12 — Учёт выходных токенов и мониторинг
**Цель:** соответствовать лицензионным ограничениям/бюджетам.
- В `model_service.py`:
  - Учёт месячных выходных токенов (авто‑сброс по месяцу), пороговый алерт (по дефолту 80%).
  - Эндпоинт `/usage` и блок `usage` в `/health`.
  - `/generate` возвращает `completion_tokens`, `monthly_usage`, `usage_ratio` и т.д.
- Рекомендации по ограничению `max_new_tokens` и кэшированию ответов.

Результат: прозрачный контроль расхода токенов для коммерческого использования.

---

## День 13 — Документация и релиз на GitHub
**Цель:** довести проект до удобного развёртывания.
- README обновлён: гибридный поиск, команды, индексация, переменные .env.
- Скрипты деплоя, systemd‑юниты, проверка синтаксиса.
- Коммит и push всех изменений в `main`.

Результат: проект подготовлен к запуску на сервере и дальнейшему развитию.

---

## Архитектура (итог)
- **Telegram Bot (`bot.py`):** регистрация, UX-команды, индексация .docx, обращение к сервису (/search → /generate), источники, порог уверенности.
- **Model Service (`model_service.py`):** llama-cpp (GGUF), Sentence‑Transformers, гибридный поиск, учёт токенов, API `/generate`/`/embed`/`/index`/`/search`/`/usage`/`/health`.
- **Данные сотрудников:** SQLite по умолчанию, поддержка MySQL/MSSQL; импорт из выгрузок 1С (CSV/JSON/TXT) и кэш в памяти.

## Безопасность
- Секреты в `.env`, логи в `logs/`.
- Рекомендации по БД: read‑only доступ, ACL, шифрование бэкапов/диска.
- Отсутствие публичной публикации сервисов; ограничение сетевого доступа.

## Эксплуатация
- Индексация: `/train` (админ) или `/index` (API); поиск `/search`; генерация `/generate`.
- Мониторинг: `/usage`, `/health`, `logs/*.log`.
- Команды для пользователей: `/start`, `'повтор'`, `/cancel`, `/status`, `/ask`, `/help`.

## Дальнейшие шаги
- Сохранение корпуса/эмбеддингов на диск (FAISS/pgvector/OpenSearch), инкрементальные апдейты.
- Реранкер Cross‑Encoder для сложных запросов и A/B‑тесты.
- ACL в RAG (по ролям/отделам). Метаданные/цитаты с подсветкой в ответе.
- Дашборды (Prometheus/Grafana): latency, hit‑rate, usage.

## Заключение
За 13 дней с нуля построен продакшн‑готовый ассистент: регистрация сотрудников, гибридный поиск по документам, сервис генерации ответов и удобный UX. Код структурирован и документирован, предусмотрена интеграция с корпоративными источниками и контроль расхода токенов. Готов к развёртыванию и масштабированию. 